<!DOCTYPE html>
<html>
<head>

    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="CSS/FormStyles.css">
    <link rel="stylesheet" href="CSS/styles.css">


  <title>Bathroom Finder</title>


</head>
<body onload="initMap()">


<div id="map"></div>


<button onclick="document.getElementById('id02').style.display='block'">New Bathroom</button>
<button onclick="document.getElementById('id04').style.display='block'">Find Bathrooms</button>


<div>
  <select id="locationSelect" style="width: 10%; "></select>
</div>

<div id="id02" class="modal">
  <span onclick="document.getElementById('id02').style.display='none' class="close" title="Close"
  Modal">times;</span>
<form class="modal-content action" action="PHP/NewLocation.php" method="post">
  <div class="container">
    <h2>New Bathroom</h2>
    <p>Please fill out the fields below to enter a new bathroom.</p>
    <hr>

    <label for="city"><b>City</b></label>
    <input type="text" placeholder="City" name="city" required><br>

    <label for="state"><b>State</b></label>
    <input type="text" placeholder="State" name="state" required><br>

    <label for="name"><b>Establishment Name</b></label>
    <input type="text" placeholder="Name" name="est_name" required><br>

    <label for="pay"><b>Pay</b></label><br>
    Yes: <input type="radio" name="pay" id="yes" value="1"><br>
    No: <input type="radio" name="pay" id="no" value="0"><br>

    <label for="latitude"><b>Latitude</b></label>
    <input type="text" placeholder="Latitude" name="latitude" required><br>

    <label for="longitude"><b>Longitude</b></label>
    <input type="text" placeholder="Longitude" name="longitude" required><br>

    <label for="rating"><b>Rating</b></label>
    <input type="text" placeholder="Rating" name="rating" required><br>

    <label for="Description"><b>description</b></label>
    <input type="text" placeholder="Description" name="description" required><br>

    <div class="clearfix">
      <button type="button" onclick="document.getElementById('id02').style.display='none'"
      class="cancelbtn">Cancel</button>
      <button type="submit" class="signupbtn">Submit Location</button>
    </div>
  </div>
</form>
</div>

<div id="id04" class="modal">
  <span onclick="document.getElementById('id04').style.display='none' class="close" title="Close"
  Modal">times;</span>
  
  <form class="modal-content action" action="FindClosestBathroom.php" method="get">
  <div class="container">
    <h4>Find Bathrooms</h4>
    <hr>
    <br>
      <label for="raddressInput">Search location:</label>
      <input type="text" id="addressInput" size="15"/>
      <label for="radiusSelect">Radius:</label>
      <select id="radiusSelect" label="Radius">
          <option value="16.0934" selected>10 Miles</option>
          <option value="8.04672">5 Miles</option>
          <option value="3.21869">2 Miles</option>
          <option value="1.60934">1 Mile</option>
      </select>
  

    <div class="clearfix">
      <button type="button" onclick="document.getElementById('id04').style.display='none'"
      class="cancelbtn">Cancel</button>
      <button type="button" id="searchButton" class="signupbtn">Find Bathrooms</button>
      <button type="button" id="searchButton1" class="locationbtn">Use Current Location</button>
      
    </div>
  </div>
</form>
</div>

<script>

var modal1 = document.getElementById('id02');
var modal3 = document.getElementById('id04');

window.onclick = function(event) {
  if (event.target == modal1 || event.target == modal3) {
    modal1.style.display = "none";
    modal3.style.display = "none";
  }

}

</script>

<script>
  var map;
  var markers = [];
  var infoWindow;
  var locationSelect;
  var current_position;

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: -34.397, lng: 150.644},
    zoom: 13,
    mapTypeId: 'roadmap',
    mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROWDOWN_MENU}
  });

  infoWindow = new google.maps.InfoWindow;

  if(navigator.geolocation) 
  {
    navigator.geolocation.getCurrentPosition(function(position)
    {
      var pos = 
      {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      current_position = pos;
      infoWindow.setPosition(pos);
      infoWindow.setContent('Location Found.');
      infoWindow.open(map);
      map.setCenter(pos);
      var marker = new google.maps.Marker(
        {
          position: pos,
          map: map
        });
      marker.setMap(map);
      markers.push(marker);
    }, function(){
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    handleLocationError(false, infoWindow, map.getCenter());
  }

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
      'Error, the geolocation service has failed' : 'Your browser does not support geolocation');
    infoWindow.open(map);
  }



  searchButton = document.getElementById('searchButton').onclick = searchLocations;
  searchButton1 = document.getElementById('searchButton1').onclick = searchLocationsNearHelper;

  locationSelect = document.getElementById('locationSelect');
  locationSelect.onchange = function() 
  {
      var markerNum = locationSelect.options[locationSelect.selectedIndex].value;
      if(markerNum != "none"){
          google.maps.event.trigger(markers[markerNum], 'click');
      }
    };
  }

  function searchLocationsNearHelper()
  {
    //createMarker(new google.maps.LatLng(current_position.lat, current_position.lng), "Current Position", "Where You Are Standing");
    searchLocationsNear(new google.maps.LatLng(current_position.lat, current_position.lng));
  }

  function searchLocations()
  {
      var address = document.getElementById('addressInput').value;
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({address: address}, function(results, status)
      {
          if(status == google.maps.GeocoderStatus.OK)
          {
            searchLocationsNear(results[0].geometry.location);
          }
          else
          {
            alert(address + 'not found');
          }
      });
  }
  
  function clearLocations()
  {
      infoWindow.close();
      for(var i = 0; i < markers.length; i++)
      {
          markers[i].setMap(null);
      }
      markers.length = 0;

      locationSelect.innerHTML = "";
      var option = document.createElement("option");
      option.value = "none";
      option.innerHTML = "See all results:";
      locationSelect.appendChild(option);
  }

  function searchLocationsNear(center)
  {
      document.getElementById('id04').style.display = 'none';
      clearLocations();
      createMarker(new google.maps.LatLng(center.lat, center.lng), "Current Position", "Right Here Dummy!");
      var radius = document.getElementById('radiusSelect').value;
      var searchUrl = "PHP/FindClosestBathroom.php?lat=" + center.lat() + "&lng=" + center.lng() + "&radius=" + radius;
      downloadUrl(searchUrl, function(data)
      {
          var xml = parseXml(data);
          var markerNodes = xml.documentElement.getElementsByTagName("marker");
          var bounds = new google.maps.LatLngBounds();
          for(var i = 0; i < markerNodes.length; i++)
          {
              var id = markerNodes[i].getAttribute("id");
              var name = markerNodes[i].getAttribute("name");
              var address = markerNodes[i].getAttribute("address");
              var distance = parseFloat(markerNodes[i].getAttribute("distance"));
              var latlng = new google.maps.LatLng(
                  parseFloat(markerNodes[i].getAttribute("lat")),
                  parseFloat(markerNodes[i].getAttribute("lng")));

            createOption(name, distance, i);
            createMarker(latlng, name, address);
            bounds.extend(latlng);
          }
          map.fitBounds(bounds);
          locationSelect.onchange = function()
          {
              var markerNum = locationSelect.options[locationSelect.selectedIndex].value;
              google.maps.event.trigger(markers[markerNum], 'click');
          };
      });
  }

  function createMarker(latlng, name, address)
  {
    alert(address);
      var html = "<b>" + name + "</b><br/>" + address;
      var marker = new google.maps.Marker({
          map: map,
          position: latlng
      });

      google.maps.event.addListener(marker, 'click', function()
      {
          infoWindow.setContent(html);
          infoWindow.open(map, marker);
      });
      markers.push(marker);
  }

  function createOption(name, distance, num)
  {
      var option = document.createElement("OPTION");
      option.value = num;
      option.innerHTML = name;
      locationSelect.appendChild(option);
  }

  function downloadUrl(url, callback)
  {
      var request = window.ActiveXObject ?
      new ActiveXObject('Microsoft.XMLHTTP') :
      new XMLHttpRequest;

      request.onreadystatechange = function()
      {
          if(request.readyState == 4)
          {
              request.onreadystatechange = doNothing;
              callback(request.responseText, request.status);
          }
      };

      request.open('GET', url, true);
      request.send(null);
  }

  function parseXml(str)
  {
      if(window.ActiveXObject)
      {
          var doc = new ActiveXObject('Microsoft.XMLDOM');
          doc.loadXML(str);
          return doc;
      }
      else if(window.DOMParser)
      {
          return (new DOMParser).parseFromString(str, 'text/xml');
      }
  }

  function doNothing() {}
</script>


<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5KLkxN6PS2oQmYYC_y7Svxhuv8oIkA4o
&callback=initMap"></script>

</body>
</html>
